<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Control Global — TCDS Master Node</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Monitor de Coherencia TCDS: Visualización de Entropía de Shannon y Locking de Fase en tiempo real.">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #030413;
      --bg-alt: #0b0f1f;
      --fg: #f5f7ff;
      --accent: #35e0ff;
      --accent2: #ff6bff;
      --accent3: #40ff9c;
      --danger: #ff6b6b;
      --warn: #f97316;
      --card-radius: 20px;
      --shadow-soft: 0 20px 50px rgba(0,0,0,0.7);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }

    body {
      background: radial-gradient(circle at top, #141b33 0%, #030413 45%, #01010a 100%);
      color: var(--fg);
      min-height: 100vh;
      padding: 20px;
    }

    .shell {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* HEADER */
    header {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .status-badge {
      font-size: 11px;
      padding: 5px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .status-ok { color: var(--accent3); border-color: var(--accent3); background: rgba(64,255,156,0.1); }
    .status-warn { color: var(--warn); border-color: var(--warn); background: rgba(249,115,22,0.1); }
    .status-err { color: var(--danger); border-color: var(--danger); background: rgba(255,107,107,0.1); }

    /* GRID LAYOUT */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .card {
      background: rgba(11, 15, 31, 0.85);
      border: 1px solid rgba(53, 224, 255, 0.15);
      border-radius: var(--card-radius);
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .card h3 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: rgba(255,255,255,0.6);
      margin-bottom: 15px;
    }

    /* KPI BOXES */
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .kpi-box {
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 12px;
      text-align: center;
    }
    .kpi-val { font-size: 24px; font-weight: 700; color: var(--fg); }
    .kpi-lbl { font-size: 10px; color: var(--accent); opacity: 0.8; margin-top: 4px; }

    /* CHART CONTAINER */
    .chart-box {
      height: 300px;
      position: relative;
    }

    /* CONTROL PANEL */
    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    
    button.ctl-btn {
      padding: 8px 16px;
      border: 1px solid var(--accent);
      background: rgba(53, 224, 255, 0.1);
      color: var(--accent);
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 700;
      transition: all 0.2s;
    }
    button.ctl-btn:hover { background: var(--accent); color: #000; }
    
    button.ctl-btn.active {
      background: var(--accent3);
      border-color: var(--accent3);
      color: #000;
    }
    
    button.ctl-btn.danger {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(255, 107, 107, 0.1);
    }
    button.ctl-btn.danger:hover { background: var(--danger); color: #000; }

    input.ctl-input {
      background: rgba(0,0,0,0.3);
      border: 1px solid #333;
      color: #fff;
      padding: 8px;
      border-radius: 6px;
      width: 80px;
    }
    
    .console-log {
      font-family: monospace;
      font-size: 10px;
      color: #888;
      margin-top: 10px;
      height: 60px;
      overflow-y: auto;
      border-top: 1px solid #222;
      padding-top: 5px;
    }
  </style>
</head>
<body>

<div class="shell">
  <header>
    <div>
      <div class="title">TCDS Master Node</div>
      <div style="font-size:11px; opacity:0.6;">Panel de Control Global v1.5 [Shannon/Arnold]</div>
    </div>
    <div id="connectionStatus" class="status-badge status-warn">Conectando...</div>
  </header>

  <div class="grid">
    <div class="card">
      <h3>Métricas de Red en Tiempo Real</h3>
      <div class="kpi-container">
        <div class="kpi-box">
          <div class="kpi-val" id="val_nodes">0</div>
          <div class="kpi-lbl">Nodos Activos</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-val" id="val_events">0</div>
          <div class="kpi-lbl">Eventos (5m)</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-val" id="val_dh" style="color:var(--accent2);">--</div>
          <div class="kpi-lbl">ΔH (Entropía)</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-val" id="val_li" style="color:var(--accent);">--</div>
          <div class="kpi-lbl">LI (Locking)</div>
        </div>
      </div>
      <div style="margin-top:15px; text-align:center;">
        <span style="font-size:11px; color:#888;">Nivel de Alerta Backend:</span>
        <strong id="alert_level_display" style="color:var(--ok); font-size:12px; text-transform:uppercase;">NONE</strong>
      </div>
    </div>

    <div class="card">
      <h3>Control Remoto de Nodos (/api/config)</h3>
      <p style="font-size:11px; color:#aaa; margin-bottom:10px;">
        Envía comandos a todos los nodos conectados.
      </p>
      
      <div class="control-row">
        <div style="display:flex; flex-direction:column; gap:5px;">
          <label style="font-size:10px;">Modo Operativo:</label>
          <div style="display:flex; gap:5px;">
            <button class="ctl-btn" onclick="sendConfig({mode_hint:'auto'})">Auto</button>
            <button class="ctl-btn" onclick="sendConfig({mode_hint:'force_scientific'})">Científico</button>
            <button class="ctl-btn danger" onclick="sendConfig({mode_hint:'force_demo'})">Forzar Demo</button>
          </div>
        </div>
      </div>

      <div class="control-row" style="margin-top:15px;">
         <div style="display:flex; flex-direction:column; gap:5px;">
          <label style="font-size:10px;">Intervalo Reporte (ms):</label>
          <div style="display:flex; gap:5px;">
            <input type="number" id="intervalInput" class="ctl-input" value="5000">
            <button class="ctl-btn" onclick="updateInterval()">Aplicar</button>
          </div>
        </div>
        
        <div style="display:flex; flex-direction:column; gap:5px; margin-left:auto;">
           <label style="font-size:10px;">Alertas Sonoras:</label>
           <button class="ctl-btn active" id="btnAlerts" onclick="toggleAlerts()">ON</button>
        </div>
      </div>
      
      <div id="consoleLog" class="console-log">Esperando acción...</div>
    </div>
  </div>

  <div class="card">
    <h3>Evolución Temporal: Entropía vs Locking</h3>
    <div class="chart-box">
      <canvas id="mainChart"></canvas>
    </div>
  </div>
</div>

<script>
  // ================= CONFIGURACIÓN =================
  const ENDPOINT_REPORT = "/api/reports"; // Relativo (mismo dominio)
  const ENDPOINT_CONFIG = "/api/config";  // Relativo (mismo dominio)

  // ================= REFERENCIAS DOM =================
  const els = {
    nodes: document.getElementById('val_nodes'),
    events: document.getElementById('val_events'),
    dh: document.getElementById('val_dh'),
    li: document.getElementById('val_li'),
    status: document.getElementById('connectionStatus'),
    alertDisplay: document.getElementById('alert_level_display'),
    console: document.getElementById('consoleLog'),
    btnAlerts: document.getElementById('btnAlerts'),
    intervalInput: document.getElementById('intervalInput')
  };

  let charts = {};
  let alertsEnabled = true;

  // ================= GRÁFICA (Chart.js) =================
  function initChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    charts.main = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Entropía Shannon (ΔH)',
            borderColor: '#ff6bff', // accent2
            backgroundColor: 'rgba(255, 107, 255, 0.1)',
            data: [],
            borderWidth: 2,
            tension: 0.4,
            yAxisID: 'y'
          },
          {
            label: 'Locking Index (LI)',
            borderColor: '#35e0ff', // accent
            backgroundColor: 'rgba(53, 224, 255, 0.1)',
            data: [],
            borderWidth: 2,
            tension: 0.4,
            yAxisID: 'y'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: '#ccc' } }
        },
        scales: {
          x: { display: false },
          y: {
            min: -1, max: 1,
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: '#666' }
          }
        },
        animation: false
      }
    });
  }

  // ================= LÓGICA DE DATOS =================
  async function fetchData() {
    try {
      const res = await fetch(ENDPOINT_REPORT);
      if(!res.ok) throw new Error("API Error");
      const data = await res.json();

      // 1. Actualizar Estado Conexión
      els.status.className = "status-badge status-ok";
      els.status.textContent = "CONECTADO: TCDS MASTER";

      // 2. Actualizar KPIs
      els.nodes.textContent = data.active_nodes || 0;
      els.events.textContent = data.cached_events || 0;
      
      const dh = data.dh_mean;
      const li = data.li_mean;
      
      els.dh.textContent = typeof dh === 'number' ? dh.toFixed(3) : '--';
      els.li.textContent = typeof li === 'number' ? li.toFixed(2) : '--';

      // 3. Actualizar Alerta Visual
      const level = data.alert_level || 'none';
      els.alertDisplay.textContent = level.toUpperCase();
      if(level === 'warning_demo') els.alertDisplay.style.color = 'var(--danger)';
      else if(level === 'watch') els.alertDisplay.style.color = 'var(--warn)';
      else els.alertDisplay.style.color = 'var(--accent3)';

      // 4. Actualizar Gráfica
      if (data.latest_raw && Array.isArray(data.latest_raw)) {
        // La API devuelve los últimos 50. Chart.js lee de izq a der.
        // Aseguramos orden cronológico (antiguo -> nuevo)
        const history = [...data.latest_raw]; 
        
        charts.main.data.labels = history.map(e => new Date(e.time).toLocaleTimeString());
        charts.main.data.datasets[0].data = history.map(e => e.metrics.dH);
        charts.main.data.datasets[1].data = history.map(e => e.metrics.LI);
        charts.main.update();
      }

    } catch (e) {
      console.warn(e);
      els.status.className = "status-badge status-err";
      els.status.textContent = "DESCONECTADO";
    }
  }

  // ================= LÓGICA DE CONTROL =================
  async function sendConfig(payload) {
    log(`Enviando config: ${JSON.stringify(payload)}...`);
    try {
      const res = await fetch(ENDPOINT_CONFIG, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if(res.ok) log("Config aplicada correctamente.");
      else log("Error al aplicar config.");
    } catch (e) {
      log("Error de red al enviar config.");
    }
  }

  function log(msg) {
    els.console.textContent = `> ${msg}`;
  }

  function updateInterval() {
    const val = parseInt(els.intervalInput.value);
    if(val > 100) sendConfig({ report_interval_ms: val });
  }

  function toggleAlerts() {
    alertsEnabled = !alertsEnabled;
    els.btnAlerts.className = alertsEnabled ? "ctl-btn active" : "ctl-btn";
    els.btnAlerts.textContent = alertsEnabled ? "ON" : "OFF";
    sendConfig({ alerts_enabled: alertsEnabled });
  }

  // ================= INICIO =================
  window.onload = () => {
    initChart();
    fetchData(); // Primer fetch inmediato
    setInterval(fetchData, 2000); // Polling cada 2s
  };
</script>

</body>
</html>
