<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reloj Causal Humano — TCDS [Shannon Entropy v1.4]</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Nodo sensor TCDS: Medición de entropía espectral de Shannon y coherencia Q-Driven.">
  <style>
    :root {
      --bg: #050713; --bg-alt: #0b0f1f; --fg: #f5f7ff;
      --accent: #35e0ff; --accent2: #ff6bff;
      --danger: #ff6b6b; --ok: #4ade80; --warn: #f97316;
      --card-radius: 20px; --shadow-soft: 0 20px 50px rgba(0,0,0,0.6);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body { background: radial-gradient(circle at top, #141b33 0%, #050713 45%, #01010a 100%); color: var(--fg); min-height: 100dvh; padding: 16px; display: flex; flex-direction: column; }
    .shell { max-width: 1100px; margin: auto; width: 100%; display: flex; flex-direction: column; gap: 18px; }

    /* --- ESTILOS DEL RELOJ --- */
    .big-clock { background: radial-gradient(circle at center, #000000 0%, #050713 70%); border-radius: 32px; padding: 24px; box-shadow: var(--shadow-soft); border: 1px solid rgba(255,255,255,0.06); position: relative; overflow: hidden; transition: 0.25s; }
    .big-clock svg { width: 100%; height: auto; display: block; }
    .big-clock.ready { border-color: rgba(56,189,248,0.7); box-shadow: 0 0 30px rgba(56,189,248,0.4); }
    
    /* --- MÓDULO DE IMPACTO SIGMA --- */
    .sigma-module {
      background: rgba(0,0,0,0.6); border: 1px solid rgba(53,224,255,0.3);
      border-radius: 16px; padding: 12px; margin-top: 10px;
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
      text-align: center;
    }
    .rule-box {
      background: rgba(255,255,255,0.05); border-radius: 8px; padding: 8px 4px;
      font-size: 10px; color: rgba(255,255,255,0.5); transition: 0.2s;
      border: 1px solid transparent;
    }
    .rule-box strong { display: block; font-size: 14px; margin-bottom: 4px; }
    /* Estados de las reglas */
    .rule-pass { background: rgba(74,222,128,0.1); border-color: var(--ok); color: var(--ok); box-shadow: 0 0 10px rgba(74,222,128,0.2); }
    .rule-fail { background: rgba(248,113,113,0.1); border-color: var(--danger); color: var(--danger); }
    
    /* Resto de estilos UI */
    .card { background: var(--bg-alt); border-radius: var(--card-radius); padding: 14px 16px; border: 1px solid rgba(255,255,255,0.06); }
    .card-title { font-size: 13px; font-weight: 600; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px; }
    .grid-2 { display: grid; grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.1fr); gap: 14px; }
    @media (max-width: 800px) { .grid-2 { grid-template-columns: 1fr; } }
    button { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
    #startBtn { background: var(--accent); color: #000; }
    #stopBtn { background: var(--danger); color: #fff; }
    .geo-tag { font-size: 10px; color: var(--accent); margin-top: 4px; display: block; }

    /* Animaciones */
    @keyframes spin-slow { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div class="shell">

  <div class="big-clock" id="bigClock">
    <div style="position:absolute; top:18px; right:22px; font-size:11px; color:var(--accent);" id="modeLabel">ESPERANDO...</div>
    <svg viewBox="0 0 1000 800" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="gradNeedle" x1="0%" y1="100%" x2="0%" y2="0%">
          <stop offset="0%" stop-color="#35e0ff"/> <stop offset="100%" stop-color="#ffffff"/>
        </linearGradient>
      </defs>
      <circle cx="500" cy="400" r="380" fill="#000"/>
      <circle cx="500" cy="400" r="375" stroke="#35e0ff" stroke-width="2" fill="none" opacity="0.3"/>
      <g transform="translate(500,400)" style="animation: spin-slow 60s linear infinite;">
        <circle r="340" fill="none" stroke="#40FF9C" stroke-width="1" stroke-dasharray="10 20" opacity="0.4"/>
      </g>
      
      <line id="tcNeedle" x1="500" y1="400" x2="500" y2="160" stroke="url(#gradNeedle)" stroke-width="8" stroke-linecap="round" transform="rotate(-60 500 400)"/>
      <line id="freqNeedle" x1="500" y1="400" x2="500" y2="110" stroke="#ff6bff" stroke-width="4" opacity="0.8"/>

      <circle cx="500" cy="400" r="15" fill="#35e0ff"/>
      <text x="500" y="480" fill="#fff" font-size="24" text-anchor="middle" opacity="0.8">t_C</text>
    </svg>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Módulo de Impacto Sigma (Auditoría TCDS)</div>
      <div style="font-size:12px; opacity:0.8; margin-bottom:8px;">
        Auditoría en tiempo real. <strong style="color:var(--accent2)">Shannon Entropy</strong> valida si la señal contiene información estructural o ruido térmico.
      </div>
      
      <div class="sigma-module">
        <div class="rule-box" id="ruleLI">
          <strong>LI &ge; 0.9</strong>
          <span>Locking Index</span>
        </div>
        <div class="rule-box" id="ruleR">
          <strong>R &gt; 0.95</strong>
          <span>Kuramoto</span>
        </div>
        <div class="rule-box" id="ruleEnt">
          <strong>&Delta;H &lt; -0.5</strong>
          <span>Shannon (Orden)</span>
        </div>
      </div>

      <div class="metrics-line" style="margin-top:12px; font-size:11px;">
        <span id="geoStatus" class="geo-tag">GPS: Esperando permisos...</span>
        <span id="timeSyncStatus" class="geo-tag" style="color:var(--ok);">Reloj: Local (Sync pendiente)</span>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Métricas y Control</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:12px; margin-bottom:12px;">
        <div>|a|: <strong id="magLive">0.00</strong></div>
        <div>LI: <strong id="liLive">0.00</strong></div>
        <div>R: <strong id="rLive">0.00</strong></div>
        <div>&Delta;H: <strong id="dHLive">0.00</strong></div>
        <div>Factor Q: <strong id="qLive" style="color:var(--accent);">--</strong></div>
        <div>Frec. Pico: <strong id="peakLive">0.00</strong> Hz</div>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="startBtn">ACTIVAR NODO</button>
        <button id="stopBtn">DETENER</button>
      </div>
    </div>
  </div>

  <footer style="text-align:center; font-size:10px; opacity:0.5; margin-top:20px;">
    Nodo Sensor Distribuido TCDS v1.4 | Genaro Carrasco Ozuna
  </footer>
</div>

<script>
  /* ================= CONFIGURACIÓN TCDS ================= */
  // URL del Backend (Vercel / Serverless)
  const REPORT_URL = "https://tcds-reloj-causal.vercel.app/api/reports"; 
  const DEVICE_ID = crypto.randomUUID ? crypto.randomUUID() : 'anon-' + Math.random();
  
  /* ================= VARIABLES DE ESTADO ================= */
  let accelBuffer = [], lastTime = 0;
  
  // Variables Métricas TCDS
  let current_LI = 0;     // Locking Index
  let current_R = 0;      // Kuramoto Proxy
  let current_dH = 0;     // Delta Shannon (Entropía Normalizada Inversa)
  let current_aMag = 0;   // Magnitud Aceleración
  let current_Q = 0;      // Factor de Calidad (Nitidez del Pico)
  let current_PeakFreq = 0;
  
  let geoData = { lat: null, lon: null, acc: null };
  let timeOffset = 0; 
  // Ventana FFT: 256 muestras permiten buena resolución en bajas frecuencias
  let N_FFT = 256; 

  /* ================= UI REFERENCES ================= */
  const ruleLI = document.getElementById('ruleLI');
  const ruleR = document.getElementById('ruleR');
  const ruleEnt = document.getElementById('ruleEnt');
  const geoStatus = document.getElementById('geoStatus');
  
  /* ================= LÓGICA DE GEOLOCALIZACIÓN ================= */
  function getGeolocation() {
    if (!navigator.geolocation) {
      geoStatus.textContent = "GPS: No soportado";
      return;
    }
    geoStatus.textContent = "GPS: Solicitando...";
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        geoData.lat = pos.coords.latitude;
        geoData.lon = pos.coords.longitude;
        geoData.acc = pos.coords.accuracy;
        geoStatus.textContent = `GPS: Activo (${geoData.lat.toFixed(4)}, ${geoData.lon.toFixed(4)})`;
        geoStatus.style.color = "var(--ok)";
      },
      (err) => {
        console.warn("Error GPS:", err);
        geoStatus.textContent = "GPS: Denegado (Nodo anónimo)";
        geoStatus.style.color = "var(--danger)";
      },
      { enableHighAccuracy: true }
    );
  }

  /* ================= ANÁLISIS ESPECTRAL Y ENTROPÍA DE SHANNON ================= */
  function computeSpectralSharpness() {
    if (accelBuffer.length < N_FFT) return;
    
    // 1. Preparar ventana de datos
    const slice = accelBuffer.slice(-N_FFT);
    const mean = slice.reduce((a,b) => a+b, 0) / N_FFT;
    
    let maxMag = 0;
    let peakFreq = 0;
    let spectrum = [];
    let totalSpectralPower = 0; 
    
    // 2. DFT DE BANDA ESTRECHA (Sismica/Humana: 0.2Hz - ~7Hz)
    // Calculamos solo los primeros 30 bins para optimizar CPU en móvil.
    for(let k = 1; k < 30; k++) { 
      let real = 0, imag = 0;
      for(let n = 0; n < N_FFT; n++) {
        const angle = -2 * Math.PI * k * n / N_FFT;
        const val = slice[n] - mean;
        real += val * Math.cos(angle);
        imag += val * Math.sin(angle);
      }
      const mag = Math.sqrt(real*real + imag*imag);
      spectrum.push(mag);
      totalSpectralPower += mag;
      
      if(mag > maxMag) {
        maxMag = mag;
        peakFreq = k * (60 / N_FFT); // Asumiendo sampling ~60Hz
      }
    }
    
    // --- A. CÁLCULO DE FACTOR Q (Nitidez del Pico) ---
    if(maxMag < 0.1) {
        current_Q = 0;
        // Si no hay energía, la entropía es máxima (incertidumbre total) o nula
        // Para TCDS, silencio = desorden potencial = 0 dH
        current_dH = 0; 
        return;
    }

    // Estimación de ancho de banda a media potencia (FWHM)
    const halfPower = maxMag * 0.5;
    let widthBins = 0;
    spectrum.forEach(mag => {
        if(mag > halfPower) widthBins++;
    });
    current_Q = widthBins > 0 ? (1.0 / widthBins) : 0;
    current_PeakFreq = peakFreq;

    // --- B. CÁLCULO DE ENTROPÍA DE SHANNON REAL ---
    // H = - sum( p * log2(p) )
    let shannonH = 0;
    if (totalSpectralPower > 0) {
        for (let mag of spectrum) {
            const p = mag / totalSpectralPower; // Probabilidad normalizada
            if (p > 0) {
                shannonH += -1 * p * Math.log2(p);
            }
        }
    }

    // Normalización TCDS:
    // Queremos mapear H (0 a log2(N)) a dH (-1 a 0)
    // H bajo (orden) -> dH cercano a -1
    // H alto (ruido) -> dH cercano a 0
    
    const maxH = Math.log2(spectrum.length || 1); // Entropía máxima posible (distribución plana)
    const normalizedH = maxH > 0 ? shannonH / maxH : 1;

    // Mapeo final
    current_dH = normalizedH - 1.0;

    // --- ACTUALIZACIÓN VISUAL ESPECTRAL ---
    document.getElementById('qLive').textContent = current_Q.toFixed(2);
    document.getElementById('peakLive').textContent = current_PeakFreq.toFixed(1);
    
    // Aguja de Frecuencia (Magenta)
    const freqAngle = -150 + (Math.min(peakFreq/10, 1) * 300);
    document.getElementById('freqNeedle').setAttribute('transform', `rotate(${freqAngle} 500 400)`);
  }

  /* ================= SINCRONIZACIÓN ================= */
  async function syncTime() {
    try {
      timeOffset = 0; 
      document.getElementById('timeSyncStatus').textContent = "Reloj: Sincronizado (Local)";
    } catch(e) {}
  }

  /* ================= FUSIÓN DE MÉTRICAS TCDS ================= */
  function updateMetrics() {
    if (accelBuffer.length < 32) return;
    
    // Estadísticas Temporales (Dominio del Tiempo)
    const slice = accelBuffer.slice(-64);
    const mean = slice.reduce((a,b)=>a+b,0)/slice.length;
    const variance = slice.reduce((a,b)=>a+Math.pow(b-mean,2),0)/slice.length;
    const std = Math.sqrt(variance);

    // LI (Locking Index): Estabilidad de la amplitud
    const noiseNorm = Math.min(std / 4, 1);
    let raw_LI = 1.0 - noiseNorm; 
    
    // Refinamiento con Factor Q (si el espectro es nítido, confiamos más)
    current_LI = (raw_LI * 0.6) + (current_Q * 0.4);
    
    // R (Kuramoto): Inferencia basada en estabilidad local
    current_R = 0.8 + (0.2 * current_LI); 
    
    // NOTA: current_dH ya fue calculado en computeSpectralSharpness usando Shannon.
    // No lo sobrescribimos aquí.

    // --- ACTUALIZACIÓN DE REGLAS VISUALES ---
    
    // Regla 1: Locking Index
    if (current_LI >= 0.9) ruleLI.className = "rule-box rule-pass";
    else ruleLI.className = "rule-box rule-fail";

    // Regla 2: Kuramoto Proxy
    if (current_R > 0.95) ruleR.className = "rule-box rule-pass";
    else ruleR.className = "rule-box"; 

    // Regla 3: Entropía de Shannon (E-Veto)
    // Umbral más estricto: -0.5 significa que la señal tiene considerable estructura
    if (current_dH < -0.5) ruleEnt.className = "rule-box rule-pass";
    else ruleEnt.className = "rule-box rule-fail";

    // --- UI NUMÉRICA ---
    document.getElementById('liLive').textContent = current_LI.toFixed(2);
    document.getElementById('rLive').textContent = current_R.toFixed(2);
    document.getElementById('dHLive').textContent = current_dH.toFixed(3);
    
    // Enviar telemetría si hay coherencia significativa
    if (current_LI > 0.85 && current_dH < -0.4) sendReport(); 
  }

  /* ================= ENVÍO DE REPORTE (Injest) ================= */
  function sendReport() {
    // Throttling simple para no saturar la red (1 reporte cada 5s max)
    const now = Date.now();
    if (window.lastReport && (now - window.lastReport < 5000)) return;
    window.lastReport = now;

    const payload = {
      device_id: DEVICE_ID,
      timestamp: now + timeOffset,
      geo: geoData,
      metrics: {
        aMag: current_aMag,
        LI: current_LI,
        R: current_R,
        dH: current_dH, // Valor real de Shannon
        Q_Arnold: current_Q 
      }
    };
    
    if (navigator.sendBeacon) {
      navigator.sendBeacon(REPORT_URL, JSON.stringify(payload));
    } else {
      fetch(REPORT_URL, { 
        method: 'POST', 
        body: JSON.stringify(payload),
        headers: {'Content-Type': 'application/json'}
      }).catch(e=>{});
    }
  }

  /* ================= HANDLERS DE SENSORES ================= */
  function handleMotion(e) {
    const a = e.accelerationIncludingGravity;
    if(!a) return;
    
    // Magnitud Vectorial 3D
    const mag = Math.hypot(a.x||0, a.y||0, a.z||0);
    
    accelBuffer.push(mag);
    if(accelBuffer.length > 512) accelBuffer.shift(); // Mantener buffer circular
    current_aMag = mag;
    
    // Aguja t_C (Cian) - Visualización de Magnitud
    // Mapeo: 9.8 m/s² (reposo) -> ~0 grados.
    const normalizedMag = Math.abs(mag - 9.8); 
    const tcAngle = -60 + (Math.min(normalizedMag/5, 1) * 120);
    document.getElementById('tcNeedle').setAttribute('transform', `rotate(${tcAngle} 500 400)`);
    document.getElementById('magLive').textContent = mag.toFixed(2);

    // Ejecutar análisis espectral cada ~100ms
    if(Date.now() % 100 < 20) computeSpectralSharpness();
    
    updateMetrics();
  }

  async function init() {
    getGeolocation();
    syncTime();
    
    // Solicitar permisos iOS 13+
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
      try {
        const permission = await DeviceMotionEvent.requestPermission();
        if (permission !== 'granted') {
          alert("Se requiere permiso de acelerómetro para el Reloj Causal.");
          return;
        }
      } catch(e) { console.error(e); }
    }
    
    window.addEventListener('devicemotion', handleMotion);
    document.getElementById('bigClock').classList.add('ready');
    document.getElementById('modeLabel').textContent = "NODO ACTIVO (SHANNON)";
  }

  document.getElementById('startBtn').onclick = init;
  document.getElementById('stopBtn').onclick = () => {
    window.removeEventListener('devicemotion', handleMotion);
    document.getElementById('bigClock').classList.remove('ready');
    document.getElementById('modeLabel').textContent = "DETENIDO";
  };
</script>
</body>
</html>
