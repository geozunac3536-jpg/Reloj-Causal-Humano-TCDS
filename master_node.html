<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Control Global ‚Äî TCDS Master Node (TRL-6)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
        content="Monitor global del Reloj Causal Humano TCDS: Entrop√≠a de Shannon, Locking Index y estado E-Veto de la red de nodos. TRL-6 validado en laboratorio.">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #030413;
      --bg-alt: #0b0f1f;
      --fg: #f5f7ff;
      --accent: #35e0ff;
      --accent2: #ff6bff;
      --accent3: #40ff9c;
      --danger: #ff6b6b;
      --warn: #f97316;
      --card-radius: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #141b33 0%, #030413 45%, #01010a 100%);
      color: var(--fg);
      min-height: 100vh;
      padding: 20px;
    }

    .shell {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* HEADER */
    header {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent);
      text-shadow: 0 0 10px rgba(53, 224, 255, 0.4);
    }

    .subtitle {
      font-size: 11px;
      opacity: 0.7;
    }

    .status-badge {
      font-size: 11px;
      padding: 5px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .status-ok {
      color: var(--accent3);
      border-color: var(--accent3);
      background: rgba(64,255,156,0.12);
    }
    .status-warn {
      color: var(--warn);
      border-color: var(--warn);
      background: rgba(249,115,22,0.12);
    }
    .status-err {
      color: var(--danger);
      border-color: var(--danger);
      background: rgba(255,107,107,0.12);
    }

    .trl-pill {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(64,255,156,0.1);
      border: 1px solid rgba(64,255,156,0.7);
      color: var(--accent3);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* LAYOUT */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    .card {
      background: rgba(11, 15, 31, 0.9);
      border: 1px solid rgba(53, 224, 255, 0.16);
      border-radius: var(--card-radius);
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.55);
      backdrop-filter: blur(5px);
    }

    .card h3 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: rgba(255,255,255,0.7);
      margin-bottom: 15px;
      border-left: 3px solid var(--accent);
      padding-left: 8px;
    }

    /* KPI METRICS */
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .kpi-box {
      background: radial-gradient(circle at top, rgba(53,224,255,0.1), rgba(0,0,0,0.35));
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .kpi-val {
      font-size: 24px;
      font-weight: 700;
      color: var(--fg);
    }
    .kpi-lbl {
      font-size: 10px;
      color: var(--accent);
      opacity: 0.8;
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* ALERT BOX */
    .alert-box {
      margin-top: 15px;
      text-align: center;
      padding: 10px;
      background: linear-gradient(90deg, rgba(0,0,0,0.45), rgba(0,0,0,0.65));
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    /* FINANCE CASCADE */
    .cascade-row {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }
    .cascade-step {
      flex: 1;
      text-align: center;
      padding: 10px 5px;
      border-radius: 8px;
      border: 1px solid;
      background: rgba(0,0,0,0.2);
    }
    .step-val {
      font-size: 16px;
      font-weight: 800;
      display: block;
      margin-bottom: 4px;
    }
    .step-lbl {
      font-size: 9px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .c-risk {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(255, 107, 107, 0.05);
    }
    .c-save {
      border-color: var(--warn);
      color: var(--warn);
      background: rgba(249, 115, 22, 0.05);
    }
    .c-fee {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(53, 224, 255, 0.05);
    }
    .c-net {
      border-color: var(--accent3);
      color: var(--accent3);
      background: rgba(64, 255, 156, 0.05);
    }
    .arrow {
      color: #666;
      font-size: 14px;
    }

    /* CONTROLES REMOTOS */
    .control-group { margin-bottom: 12px; }
    .control-label {
      font-size: 10px;
      opacity: 0.7;
      margin-bottom: 6px;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    button.ctl-btn {
      padding: 8px 12px;
      border: 1px solid var(--accent);
      background: rgba(53, 224, 255, 0.1);
      color: var(--accent);
      border-radius: 6px;
      cursor: pointer;
      font-size: 10px;
      text-transform: uppercase;
      font-weight: 700;
      transition: all 0.2s;
    }
    button.ctl-btn:hover {
      background: var(--accent);
      color: #000;
      box-shadow: 0 0 10px var(--accent);
    }
    button.ctl-btn.danger {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(255, 107, 107, 0.1);
    }
    button.ctl-btn.danger:hover {
      background: var(--danger);
      color: #000;
      box-shadow: 0 0 10px var(--danger);
    }

    .console-log {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 9px;
      color: #a0a8c0;
      height: 54px;
      overflow-y: auto;
      border-top: 1px solid #222;
      padding-top: 5px;
      margin-top: 10px;
      background: rgba(0,0,0,0.25);
      border-radius: 8px;
      padding-left: 6px;
    }

    /* STATUS DOT (œÜ / borderline / Q) */
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 6px;
    }
    .status-dot.phi {
      background: var(--danger);
      box-shadow: 0 0 8px rgba(255,107,107,0.7);
    }
    .status-dot.borderline {
      background: var(--warn);
      box-shadow: 0 0 8px rgba(249,115,22,0.7);
    }
    .status-dot.q {
      background: var(--accent3);
      box-shadow: 0 0 8px rgba(64,255,156,0.7);
    }

    /* CHART */
    .chart-box {
      height: 280px;
      position: relative;
    }

    footer {
      text-align: center;
      margin-top: 26px;
      opacity: 0.9;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    footer a {
      opacity: 0.9;
      transition: opacity 0.2s, transform 0.2s;
    }
    footer a:hover {
      opacity: 1;
      transform: translateY(-1px);
    }
  </style>
</head>
<body>

<div class="shell">
  <header>
    <div>
      <div class="title">TCDS Master Node</div>
      <div class="subtitle">
        Panel Global del Reloj Causal Humano ‚Äî <strong>TRL-6</strong> (Laboratorio) ¬∑ Entrop√≠a de Shannon &amp; Locking Œ£
      </div>
    </div>
    <div id="connectionStatus" class="status-badge status-warn">
      <span>Conectando a /api/reports‚Ä¶</span>
      <span class="trl-pill">TRL-6 ¬∑ DOI</span>
    </div>
  </header>

  <div class="grid">
    <!-- Estado de red f√≠sica -->
    <div class="card">
      <h3>Estado de la Red (F√≠sica)</h3>
      <div class="kpi-container">
        <div class="kpi-box">
          <div class="kpi-val" id="val_nodes">0</div>
          <div class="kpi-lbl">Nodos Activos</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-val" id="val_events">0</div>
          <div class="kpi-lbl">Ventanas Œ£ (Lapso)</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-val" id="val_dh" style="color:var(--accent2);">--</div>
          <div class="kpi-lbl">ŒîH (Entrop√≠a Media)</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-val" id="val_li" style="color:var(--accent);">--</div>
          <div class="kpi-lbl">LI (Locking Medio)</div>
        </div>
      </div>

      <div class="alert-box">
        <span style="font-size:10px; color:#9ca3c7; text-transform:uppercase; letter-spacing:0.08em;">
          Estado E-Veto Global:
        </span><br />
        <strong id="alert_level_display"
                style="font-size:14px; letter-spacing:0.1em; color:var(--accent3);">
          ESPERANDO DATOS
        </strong>
      </div>

      <div style="margin-top:10px; font-size:10px; color:#9aa3c2;">
        <span id="statusDot" class="status-dot phi"></span>
        <span id="statusText">
          Interpretaci√≥n E-Veto: sin datos suficientes. Se requiere actividad de nodos.
        </span>
      </div>
    </div>

    <!-- Cascada econ√≥mica TRL-6 -->
    <div class="card">
      <h3>Proyecci√≥n Econ√≥mica TRL-6 (Escenario Puebla-Morelos)</h3>
      <p style="font-size:10px; color:#cbd5f5; margin-bottom:10px;">
        Modelo de valor basado en la regla <strong>Œ± ¬∑ I<sub>Œ£</sub> ¬∑ ŒîE<sub>AL</sub></strong>.<br />
        La madurez TRL-6 proviene de un prototipo demostrado en entorno relevante, con E-Veto cerrando
        el loop f√≠sico-coherencial.
      </p>

      <div class="cascade-row">
        <div class="cascade-step c-risk">
          <span class="step-val">$300M</span>
          <span class="step-lbl">Riesgo Anual (EAL)</span>
        </div>
        <div class="arrow">‚Üí</div>
        <div class="cascade-step c-save">
          <span class="step-val">$30M</span>
          <span class="step-lbl">Ahorro Potencial (10%)</span>
        </div>
      </div>

      <div class="cascade-row">
        <div class="arrow" style="transform:rotate(90deg); margin-left:25%;">‚Üì</div>
        <div class="arrow" style="transform:rotate(90deg); margin-right:25%;">‚Üì</div>
      </div>

      <div class="cascade-row">
        <div class="cascade-step c-fee">
          <span class="step-val">$6M</span>
          <span class="step-lbl">Inversi√≥n Anual TCDS</span>
        </div>
        <div class="cascade-step c-net">
          <span class="step-val">$24M</span>
          <span class="step-lbl">Retorno Neto</span>
        </div>
      </div>

      <div style="margin-top:10px; text-align:right; font-size:9px; color:#8b93b3;">
        *Cifras indicativas basadas en el One-Pager TRL-6 y la validaci√≥n E-Veto Œ£.
      </div>
    </div>

    <!-- Control remoto de nodos -->
    <div class="card">
      <h3>Control de Nodos (/api/config)</h3>
      <div class="control-group">
        <span class="control-label">Modo Operativo Global:</span>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button class="ctl-btn" onclick="sendConfig({mode_hint:'auto'})">Auto</button>
          <button class="ctl-btn" onclick="sendConfig({mode_hint:'force_scientific'})">Cient√≠fico</button>
          <button class="ctl-btn danger" onclick="sendConfig({mode_hint:'force_demo'})">Forzar Demo</button>
        </div>
      </div>

      <div class="control-group" style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div>
          <span class="control-label">Alertas Œ£:</span>
          <button class="ctl-btn" id="btnAlerts" onclick="toggleAlerts()">ACTIVAS</button>
        </div>
        <div style="text-align:right;">
          <span class="control-label">Intervalo de Ventana (ms):</span>
          <input type="number" id="intervalInput" value="5000"
                 style="width:70px; background:#050716; border:1px solid #444; color:#fff; padding:4px; border-radius:4px; font-size:10px;">
          <button class="ctl-btn" onclick="updateInterval()">OK</button>
        </div>
      </div>

      <div id="consoleLog" class="console-log">
        &gt; Sistema listo. Esperando comandos y datos de /api/reports.
      </div>
    </div>
  </div>

  <!-- Gr√°fica principal -->
  <div class="card">
    <h3>Evoluci√≥n Temporal ‚Äî Entrop√≠a ŒîH vs Locking LI (Firma de la Red)</h3>
    <div class="chart-box">
      <canvas id="mainChart"></canvas>
    </div>
  </div>

  <footer>
    <div style="font-weight:600; text-transform:uppercase; letter-spacing:0.12em;">
      Reloj Causal Humano ‚Äî TCDS ¬∑ Nodo Maestro TRL-6
    </div>

    <!-- Emblema DOI TRL-6 -->
    <a href="https://doi.org/10.5281/zenodo.17677864" target="_blank" rel="noopener">
      <img src="https://zenodo.org/badge/DOI/10.5281/zenodo.17677864.svg"
           alt="DOI: 10.5281/zenodo.17677864" style="height:22px;">
    </a>

    <div style="font-size:10px; color:#9ca3c7;">
      DOI anterior consolida el nivel <strong>TRL-6</strong> del sistema, documentando la fase de laboratorio del Reloj Causal Humano.
    </div>

    <div style="font-size:10px; color:#6b7280;">
      ¬© 2025 Genaro Carrasco Ozuna ‚Äî <a href="https://geozunac3536-jpg.github.io" target="_blank" rel="noopener" style="color:var(--accent); text-decoration:none;">geozunac3536-jpg.github.io</a><br/>
      Licencias: CC BY-NC-SA 4.0 &amp; TCDS-Commercial ¬∑ Contacto: <a href="mailto:geozunac3536@gmail.com" style="color:var(--accent); text-decoration:none;">geozunac3536@gmail.com</a>
    </div>
  </footer>
</div>

<script>
  const ENDPOINT_REPORT = "/api/reports";
  const ENDPOINT_CONFIG = "/api/config";

  const els = {
    status: document.getElementById("connectionStatus"),
    nodes: document.getElementById("val_nodes"),
    events: document.getElementById("val_events"),
    dh: document.getElementById("val_dh"),
    li: document.getElementById("val_li"),
    alertDisplay: document.getElementById("alert_level_display"),
    statusDot: document.getElementById("statusDot"),
    statusText: document.getElementById("statusText"),
    console: document.getElementById("consoleLog"),
    btnAlerts: document.getElementById("btnAlerts"),
    intervalInput: document.getElementById("intervalInput")
  };

  let charts = {};
  let alertsEnabled = true;

  function log(msg) {
    els.console.textContent = "> " + msg;
    els.console.scrollTop = els.console.scrollHeight;
  }

  // ==================== CHART INIT ====================
  function initChart() {
    const ctx = document.getElementById("mainChart").getContext("2d");
    charts.main = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Entrop√≠a Shannon (ŒîH)",
            data: [],
            borderWidth: 2,
            tension: 0.3,
            fill: true
          },
          {
            label: "Locking Index (LI)",
            data: [],
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: {
            labels: { color: "#9aa3c2", font: { size: 10 } }
          }
        },
        scales: {
          x: {
            display: false,
            grid: { color: "rgba(255,255,255,0.05)" }
          },
          y: {
            min: -1.1,
            max: 1.1,
            grid: { color: "rgba(255,255,255,0.08)" },
            ticks: { color: "#9aa3c2", font: { size: 9 } }
          }
        },
        animation: { duration: 0 }
      }
    });
  }

  // ==================== E-VETO GLOBAL ====================
  function updateStatusFromStats(stats) {
    const { counts, averages } = stats;
    const total = counts.phi + counts.borderline + counts.q;

    els.statusDot.classList.remove("phi", "borderline", "q");

    if (!total) {
      els.statusDot.classList.add("phi");
      els.statusText.textContent =
        "Interpretaci√≥n E-Veto: sin datos a√∫n (esperando reportes de nodos).";
      return;
    }

    const pctPhi = (counts.phi / total * 100).toFixed(1);
    const pctBorder = (counts.borderline / total * 100).toFixed(1);
    const pctQ = (counts.q / total * 100).toFixed(1);

    let mode = "phi";
    if (counts.q > counts.phi && counts.q > counts.borderline) mode = "q";
    else if (counts.borderline >= counts.phi && counts.borderline >= counts.q) mode = "borderline";

    els.statusDot.classList.add(
      mode === "phi" ? "phi" : mode === "q" ? "q" : "borderline"
    );

    if (mode === "phi") {
      els.statusText.textContent =
        `E-Veto: lapso mayormente œÜ-driven (ruido estructural). Q-driven ‚âà ${pctQ}% de ventanas.`;
    } else if (mode === "borderline") {
      els.statusText.textContent =
        `E-Veto: r√©gimen borderline entre ruido y coherencia. Q-driven ‚âà ${pctQ}% de ventanas.`;
    } else {
      els.statusText.textContent =
        `E-Veto: r√©gimen con fracci√≥n significativa Q-driven (~${pctQ}% de ventanas coherentes).`;
    }
  }

  function updateChartFromHistory(latest_raw) {
    const labels = [];
    const dhData = [];
    const liData = [];

    latest_raw.forEach((e, idx) => {
      const label = e.ts ? e.ts.slice(11, 19) : "#" + idx;
      labels.push(label);
      dhData.push(typeof e.dh === "number" ? e.dh : null);
      liData.push(typeof e.li === "number" ? e.li : null);
    });

    charts.main.data.labels = labels;
    charts.main.data.datasets[0].data = dhData;
    charts.main.data.datasets[1].data = liData;
    charts.main.update();
  }

  function mapAlertLevel(level) {
    if (level === "warning_demo") {
      els.alertDisplay.textContent = "‚ö†Ô∏è ALERTA S√çSMICA (DEMO TRL-6)";
      els.alertDisplay.style.color = "var(--danger)";
    } else if (level === "watch") {
      els.alertDisplay.textContent = "üëÅÔ∏è VIGILANCIA (WATCH Œ£)";
      els.alertDisplay.style.color = "var(--warn)";
    } else {
      els.alertDisplay.textContent = "üü¢ SISTEMA NOMINAL TRL-6";
      els.alertDisplay.style.color = "var(--accent3)";
    }
  }

  // ==================== FETCH /api/reports ====================
  async function fetchData() {
    try {
      const res = await fetch(ENDPOINT_REPORT);
      if (!res.ok) throw new Error("API offline: " + res.status);
      const data = await res.json();

      els.status.className = "status-badge status-ok";
      els.status.innerHTML =
        '<span>ONLINE: /api/reports</span> <span class="trl-pill">TRL-6 ¬∑ DOI</span>';

      const stats = data.stats || { counts: {phi:0,borderline:0,q:0}, averages: {} };
      const counts = stats.counts;
      const averages = stats.averages || {};

      els.nodes.textContent = (data.active_nodes != null ? data.active_nodes : 0).toString();
      els.events.textContent = (data.cached_events != null ? data.cached_events : stats.total_events || 0).toString();

      els.dh.textContent = averages.dh != null ? averages.dh.toFixed(3) : "--";
      els.li.textContent = averages.li != null ? averages.li.toFixed(2) : "--";

      mapAlertLevel(data.alert_level || "none");
      updateStatusFromStats(stats);
      updateChartFromHistory(data.latest_raw || []);

      log("Datos actualizados desde /api/reports.");
    } catch (e) {
      console.warn(e);
      els.status.className = "status-badge status-err";
      els.status.innerHTML =
        '<span>DESCONECTADO de /api/reports</span> <span class="trl-pill">TRL-6 ¬∑ OFFLINE</span>';
      log("No se pudo leer /api/reports. Verifica backend.");
    }
  }

  // ==================== CONTROL REMOTO (/api/config) ====================
  async function sendConfig(payload) {
    log("Enviando comando: " + JSON.stringify(payload));
    try {
      const res = await fetch(ENDPOINT_CONFIG, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        log("Comando aceptado por /api/config.");
      } else {
        log("Error en /api/config: HTTP " + res.status);
      }
    } catch (e) {
      log("Fallo de red al contactar /api/config.");
    }
  }

  function updateInterval() {
    const val = parseInt(els.intervalInput.value, 10);
    if (val > 100) {
      sendConfig({ report_interval_ms: val });
    } else {
      log("Intervalo demasiado peque√±o, ignoro.");
    }
  }

  function toggleAlerts() {
    alertsEnabled = !alertsEnabled;
    els.btnAlerts.textContent = alertsEnabled ? "ACTIVAS" : "SILENCIO";
    els.btnAlerts.style.opacity = alertsEnabled ? "1" : "0.5";
    sendConfig({ alerts_enabled: alertsEnabled });
  }

  // ==================== INIT ====================
  window.onload = () => {
    initChart();
    fetchData();
    setInterval(fetchData, 5000);
  };
</script>

</body>
</html>
